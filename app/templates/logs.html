<div class="flex flex-col h-full bg-gray-800 rounded-lg shadow-xl overflow-hidden" id="logs-container">
    <!-- Header with Filters -->
    <div class="flex flex-wrap justify-between items-center p-3 bg-gray-900 border-b border-gray-700">
        <div class="flex items-center gap-2 mb-2 sm:mb-0">
            <span class="text-sm font-mono text-gray-400">ID: {{ container_id[:12] }}</span>
        </div>

        <form class="flex flex-wrap items-center gap-2" hx-get="/containers/{{ host_name }}/{{ container_id }}/logs"
            hx-target="#logs-container" hx-swap="outerHTML" hx-indicator="#loading-spinner">

            <!-- Range/Tail Selector Input -->
            <input type="number" name="tail" value="{{ tail }}" placeholder="Строк (1000)" title="Строк"
                class="bg-gray-800 text-gray-200 text-xs py-1 px-2 rounded border border-gray-600 focus:border-blue-500 outline-none w-20">

            <!-- Start Time -->
            <input type="datetime-local" name="since" value="{{ since|default('', true) }}" title="Начало"
                class="bg-gray-800 text-gray-200 text-xs py-1 px-2 rounded border border-gray-600 focus:border-blue-500 outline-none">

            <span class="text-gray-500">-</span>

            <!-- End Time -->
            <input type="datetime-local" name="until" value="{{ until|default('', true) }}" title="Конец"
                class="bg-gray-800 text-gray-200 text-xs py-1 px-2 rounded border border-gray-600 focus:border-blue-500 outline-none">

            <!-- Real-time Toggle -->
            <label
                class="flex items-center space-x-2 cursor-pointer bg-gray-700 px-2 py-1 rounded hover:bg-gray-600 transition ml-2">
                <input type="checkbox" id="realtime-toggle"
                    class="form-checkbox h-3 w-3 text-green-500 rounded sm:h-4 sm:w-4" onchange="toggleRealtime(this)">
                <span class="text-xs text-gray-300 font-bold">Live</span>
            </label>

            <!-- Search -->
            <input type="text" name="search" value="{{ search|default('', true) }}" placeholder="Поиск текста..."
                class="bg-gray-800 text-gray-200 text-xs py-1 px-2 rounded border border-gray-600 focus:border-blue-500 outline-none w-28">

            <button type="submit"
                class="bg-blue-700 hover:bg-blue-600 text-white px-3 py-1 rounded text-xs transition flex items-center gap-1">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
                Найти
            </button>
            <div id="loading-spinner" class="htmx-indicator ml-2">
                <svg class="animate-spin h-4 w-4 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none"
                    viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor"
                        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                    </path>
                </svg>
            </div>
        </form>

        <div class="flex gap-2">
            <a href="/containers/{{ host_name }}/{{ container_id }}/logs?download=true&tail={{ tail }}&since={{ since|default('', true) }}&until={{ until|default('', true) }}&search={{ search|default('', true) }}"
                target="_blank" download="logs.txt"
                class="bg-gray-700 hover:bg-gray-600 text-gray-200 px-3 py-1 rounded text-xs flex items-center gap-1">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                </svg>
                Скачать
            </a>
            <button onclick="document.getElementById('log-modal').close()"
                class="text-gray-400 hover:text-white transition">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
    </div>

    <!-- Static Logs View -->
    <div id="log-content-static"
        class="bg-black p-4 overflow-auto flex-1 font-mono text-xs text-gray-300 leading-relaxed whitespace-pre-wrap break-all h-full custom-scrollbar">
        {{ logs }}
    </div>

    <!-- Live Logs View (Hidden by default) -->
    <div id="log-content-live"
        class="bg-[#0c0c0c] p-4 overflow-auto flex-1 font-mono text-xs text-green-400 leading-relaxed whitespace-pre-wrap break-all h-full custom-scrollbar hidden border-t-2 border-green-900/30">
        <div class="text-center text-gray-500 my-4 select-none">--- Ожидание подключения к Live Stream ---</div>
    </div>

    <script>
        var ws = null;
        var hostName = "{{ host_name }}";
        var containerId = "{{ container_id }}";
        var staticView = document.getElementById('log-content-static');
        var liveView = document.getElementById('log-content-live');

        // Scroll to bottom initially
        if (staticView) staticView.scrollTop = staticView.scrollHeight;

        function toggleRealtime(checkbox) {
            if (checkbox.checked) {
                // Enable Live Mode
                staticView.classList.add('hidden');
                liveView.classList.remove('hidden');
                startWebSocket();
            } else {
                // Disable Live Mode
                staticView.classList.remove('hidden');
                liveView.classList.add('hidden');
                stopWebSocket();
            }
        }

        function startWebSocket() {
            if (ws) return;

            // Get tail value from input
            var tailInput = document.querySelector('input[name="tail"]');
            var tailValue = tailInput ? tailInput.value : "100";

            liveView.innerHTML = '<div class="text-gray-500 mb-2">--- Подключение... ---</div>';

            var protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            var url = `${protocol}//${window.location.host}/ws/logs/${hostName}/${containerId}?tail=${tailValue}`;

            ws = new WebSocket(url);

            ws.onopen = function () {
                liveView.innerHTML = '<div class="text-green-500 font-bold mb-2">--- Live Stream Connected ---</div>';
            };

            ws.onmessage = function (event) {
                var isScrolledToBottom = Math.abs(liveView.scrollHeight - liveView.clientHeight - liveView.scrollTop) < 50;

                // Append text directly
                liveView.append(event.data);

                if (isScrolledToBottom) {
                    liveView.scrollTop = liveView.scrollHeight;
                }
            };

            ws.onclose = function () {
                var marker = document.createElement('div');
                marker.className = "text-red-500 font-bold my-2";
                marker.textContent = "--- Live Stream Closed ---";
                liveView.appendChild(marker);
                ws = null;
            };

            ws.onerror = function (err) {
                console.error("WS Error", err);
                var marker = document.createElement('div');
                marker.className = "text-red-500 font-bold my-2";
                marker.textContent = "--- Connection Error (Check Logs) ---";
                liveView.appendChild(marker);
            }
        }

        function stopWebSocket() {
            if (ws) {
                ws.close();
            }
        }
    </script>
</div>