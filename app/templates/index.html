{% extends "base.html" %}

{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
    <!-- Sidebar / Hosts -->
    <div class="lg:col-span-1 space-y-6">
        <div class="bg-gray-800 p-4 rounded-lg border border-gray-700">
            <h2 class="text-lg font-bold mb-4 flex items-center justify-between gap-2">
                <div class="flex items-center gap-2">
                    <span>üñ•Ô∏è</span> –£–ø—Ä–∞–≤–ª—è–µ–º—ã–µ –•–æ—Å—Ç—ã
                </div>
                <button hx-get="/containers/list" hx-target="#container-list"
                    class="text-xs bg-gray-700 hover:bg-gray-600 px-2 py-1 rounded transition text-gray-300">
                    –í—Å–µ
                </button>
            </h2>

            <!-- Host Search -->
            <div class="mb-4">
                <div class="relative">
                    <input type="text" id="host-search" placeholder="–ü–æ–∏—Å–∫: @hostname –∏–ª–∏ —á–∞—Å—Ç—å –∏–º–µ–Ω–∏..."
                        class="w-full bg-gray-700 rounded-lg p-2 pl-8 text-sm border border-gray-600 focus:border-blue-500 focus:outline-none transition"
                        oninput="filterHosts(this.value)">
                    <span class="absolute left-2.5 top-2.5 text-gray-400">üîç</span>
                </div>
            </div>

            <!-- Environments -->
            <div id="hosts-container" class="space-y-3 mb-4">
                {% for env in environments %}
                <details class="bg-gray-700/30 rounded-lg overflow-hidden" open>
                    <summary
                        class="cursor-pointer px-3 py-2 bg-gradient-to-r from-purple-900/50 to-gray-800 hover:from-purple-800/50 transition flex justify-between items-center">
                        <div class="flex items-center gap-2">
                            <span class="text-purple-400">üìÅ</span>
                            <span class="font-bold text-purple-200">{{ env.name }}</span>
                            <span class="text-xs text-gray-400">({{ env.hosts|length }})</span>
                        </div>
                        <form action="/environments/{{ env.id }}/delete" method="post" class="inline"
                            onsubmit="event.stopPropagation(); return confirm('–£–¥–∞–ª–∏—Ç—å —Å—Ä–µ–¥—É {{ env.name }}? –•–æ—Å—Ç—ã –±—É–¥—É—Ç –ø–µ—Ä–µ–º–µ—â–µ–Ω—ã –≤ –ë–µ–∑ —Å—Ä–µ–¥—ã.')">
                            <button type="submit" class="text-xs text-red-400 hover:text-red-300 px-1"
                                onclick="event.stopPropagation()">
                                ‚úï
                            </button>
                        </form>
                    </summary>
                    <ul class="p-2 space-y-1">
                        {% for host in env.hosts %}
                        <li class="host-item flex justify-between items-center bg-gray-700/50 p-2 rounded text-sm hover:bg-gray-700 transition group cursor-pointer"
                            data-host-name="{{ host.name|lower }}" hx-get="/containers/list?host_name={{ host.name }}"
                            hx-target="#container-list">
                            <span class="font-mono group-hover:text-blue-300 font-bold transition">{{ host.name
                                }}</span>
                            <div class="flex items-center gap-1">
                                <button
                                    class="text-xs bg-gray-600/50 hover:bg-gray-600 text-gray-300 px-1.5 py-0.5 rounded transition"
                                    hx-get="/hosts/{{ host.id }}/details" hx-target="body" hx-swap="beforeend"
                                    onclick="event.stopPropagation()" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">
                                    ‚öôÔ∏è
                                </button>
                                <button
                                    class="text-xs bg-purple-900/50 hover:bg-purple-800 text-purple-200 px-1.5 py-0.5 rounded border border-purple-700 transition"
                                    hx-get="/images/{{ host.name }}" hx-target="body" hx-swap="beforeend"
                                    onclick="event.stopPropagation()" title="–û–±—Ä–∞–∑—ã">
                                    üì¶
                                </button>
                                <span class="text-xs text-gray-400 uppercase border border-gray-600 px-1 rounded">{{
                                    host.type }}</span>
                            </div>
                        </li>
                        {% else %}
                        <li class="text-xs text-gray-500 italic px-2">–ù–µ—Ç —Ö–æ—Å—Ç–æ–≤</li>
                        {% endfor %}
                    </ul>
                </details>
                {% endfor %}

                <!-- Ungrouped Hosts -->
                {% if ungrouped_hosts %}
                <details class="bg-gray-700/30 rounded-lg overflow-hidden">
                    <summary
                        class="cursor-pointer px-3 py-2 bg-gray-700/50 hover:bg-gray-700 transition flex justify-between items-center">
                        <div class="flex items-center gap-2">
                            <span class="text-gray-400">üìÇ</span>
                            <span class="font-bold text-gray-400">–ë–µ–∑ —Å—Ä–µ–¥—ã</span>
                            <span class="text-xs text-gray-500">({{ ungrouped_hosts|length }})</span>
                        </div>
                    </summary>
                    <ul class="p-2 space-y-1">
                        {% for host in ungrouped_hosts %}
                        <li class="host-item flex justify-between items-center bg-gray-700/50 p-2 rounded text-sm hover:bg-gray-700 transition group cursor-pointer"
                            data-host-name="{{ host.name|lower }}" hx-get="/containers/list?host_name={{ host.name }}"
                            hx-target="#container-list">
                            <span class="font-mono group-hover:text-blue-300 font-bold transition">{{ host.name
                                }}</span>
                            <div class="flex items-center gap-1">
                                <button
                                    class="text-xs bg-gray-600/50 hover:bg-gray-600 text-gray-300 px-1.5 py-0.5 rounded transition"
                                    hx-get="/hosts/{{ host.id }}/details" hx-target="body" hx-swap="beforeend"
                                    onclick="event.stopPropagation()" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">
                                    ‚öôÔ∏è
                                </button>
                                <button
                                    class="text-xs bg-purple-900/50 hover:bg-purple-800 text-purple-200 px-1.5 py-0.5 rounded border border-purple-700 transition"
                                    hx-get="/images/{{ host.name }}" hx-target="body" hx-swap="beforeend"
                                    onclick="event.stopPropagation()" title="–û–±—Ä–∞–∑—ã">
                                    üì¶
                                </button>
                                <span class="text-xs text-gray-400 uppercase border border-gray-600 px-1 rounded">{{
                                    host.type }}</span>
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                </details>
                {% endif %}
            </div>

            <!-- Add Environment -->
            <details class="text-sm mb-3">
                <summary class="cursor-pointer text-purple-400 hover:text-purple-300">‚ûï –°–æ–∑–¥–∞—Ç—å –°—Ä–µ–¥—É</summary>
                <form action="/environments/add" method="post" class="mt-3 space-y-2 p-2 bg-gray-700/30 rounded">
                    <input type="text" name="name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Å—Ä–µ–¥—ã (test1, production...)"
                        class="w-full bg-gray-700 rounded p-2 text-xs border border-gray-600" required>
                    <button class="w-full bg-purple-700 hover:bg-purple-600 text-white p-2 rounded text-xs">–°–æ–∑–¥–∞—Ç—å
                        –°—Ä–µ–¥—É</button>
                </form>
            </details>

            <!-- Add Host -->
            <details class="text-sm">
                <summary class="cursor-pointer text-blue-400 hover:text-blue-300">‚ûï –î–æ–±–∞–≤–∏—Ç—å –•–æ—Å—Ç</summary>
                <form action="/hosts/add" method="post" class="mt-3 space-y-2 p-2 bg-gray-700/30 rounded">
                    <input type="text" name="name" placeholder="–ò–º—è –•–æ—Å—Ç–∞"
                        class="w-full bg-gray-700 rounded p-2 text-xs border border-gray-600" required>
                    <select name="environment_id" class="w-full bg-gray-700 rounded p-2 text-xs border border-gray-600">
                        <option value="">‚Äî –ë–µ–∑ —Å—Ä–µ–¥—ã ‚Äî</option>
                        {% for env in environments %}
                        <option value="{{ env.id }}">{{ env.name }}</option>
                        {% endfor %}
                    </select>
                    <select name="type" class="w-full bg-gray-700 rounded p-2 text-xs border border-gray-600">
                        <option value="ssh">SSH</option>
                        <option value="local">–õ–æ–∫–∞–ª—å–Ω—ã–π –°–æ–∫–µ—Ç</option>
                    </select>
                    <input type="text" name="ip" placeholder="IP –ê–¥—Ä–µ—Å (SSH)"
                        class="w-full bg-gray-700 rounded p-2 text-xs border border-gray-600">
                    <input type="number" name="port" placeholder="–ü–æ—Ä—Ç (22)"
                        class="w-full bg-gray-700 rounded p-2 text-xs border border-gray-600">
                    <input type="text" name="ssh_user" placeholder="–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å SSH"
                        class="w-full bg-gray-700 rounded p-2 text-xs border border-gray-600">
                    <input type="text" name="ssh_password" placeholder="–ü–∞—Ä–æ–ª—å SSH (–ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)"
                        class="w-full bg-gray-700 rounded p-2 text-xs border border-gray-600">
                    <button class="w-full bg-green-700 hover:bg-green-600 text-white p-2 rounded text-xs">–î–æ–±–∞–≤–∏—Ç—å
                        –•–æ—Å—Ç</button>
                </form>
            </details>
        </div>
    </div>

    <!-- Main Content / Containers -->
    <div class="lg:col-span-3 space-y-6">
        {% if errors %}
        <div class="bg-red-900/50 border border-red-800 p-4 rounded text-sm text-red-200">
            <p class="font-bold">–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –æ—à–∏–±–∫–∏:</p>
            <ul class="list-disc pl-5">
                {% for err in errors %}
                <li>{{ err }}</li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}

        <div class="bg-gray-800 rounded-lg border border-gray-700 overflow-hidden">
            <div class="p-4 bg-gray-800 border-b border-gray-700 flex justify-between items-center">
                <h2 class="text-xl font-bold flex items-center gap-2">
                    üì¶ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
                    <span id="ws-status" class="w-2 h-2 rounded-full bg-red-500 transition"
                        title="Realtime —Å—Ç–∞—Ç—É—Å"></span>
                </h2>
                <button onclick="location.reload()"
                    class="bg-gray-700 hover:bg-gray-600 px-3 py-1 rounded text-sm">–û–±–Ω–æ–≤–∏—Ç—å</button>
            </div>

            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left">
                    <thead class="text-xs text-gray-400 uppercase bg-gray-700/50">
                        <tr>
                            <th class="px-4 py-3">–°—Ç–∞—Ç—É—Å</th>
                            <th class="px-4 py-3">–ò–º—è</th>
                            <th class="px-4 py-3">–û–±—Ä–∞–∑</th>
                            <th class="px-4 py-3">–°–æ–∑–¥–∞–Ω</th>
                            <th class="px-4 py-3">–ü–æ—Ä—Ç—ã</th>
                            <th class="px-4 py-3">–•–æ—Å—Ç</th>
                            <th class="px-4 py-3 text-right">–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody id="container-list" class="divide-y divide-gray-700">
                        {% include "partials/container_rows.html" %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Logs -->
<dialog id="log-modal" class="bg-transparent p-0 w-[95%] max-w-7xl backdrop:bg-black/90 h-[90vh]">
    <div class="bg-gray-900 border border-gray-700 rounded-lg shadow-2xl flex flex-col h-full">
        <div class="p-4 border-b border-gray-800 flex justify-between items-center bg-gray-800 rounded-t-lg">
            <h3 class="font-bold flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-400" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                –õ–æ–≥–∏ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
            </h3>
            <div class="flex items-center gap-4">
                <span class="text-xs text-gray-500">–®–∏—Ä–∏–Ω–∞: Auto | Wrap: On</span>
                <button onclick="document.getElementById('log-modal').close()"
                    class="text-gray-400 hover:text-white transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
        </div>
        <div id="modal-content" class="p-0 overflow-hidden flex-1 flex flex-col">
            –ó–∞–≥—Ä—É–∑–∫–∞...
        </div>
    </div>
</dialog>

<script>
    // ===== Host Search Filter =====
    function filterHosts(query) {
        const searchTerm = query.replace(/^@/, '').toLowerCase().trim();

        const hostItems = document.querySelectorAll('.host-item');
        const envSections = document.querySelectorAll('#hosts-container > details');

        hostItems.forEach(item => {
            const hostName = item.getAttribute('data-host-name') || '';
            const matches = searchTerm === '' || hostName.includes(searchTerm);
            item.style.display = matches ? '' : 'none';
        });

        envSections.forEach(section => {
            const visibleHosts = section.querySelectorAll('.host-item:not([style*="display: none"])');
            section.style.display = visibleHosts.length > 0 || searchTerm === '' ? '' : 'none';
            if (searchTerm !== '' && visibleHosts.length > 0) {
                section.open = true;
            }
        });
    }

    // ===== Realtime Container Status =====
    let statusSocket = null;
    let currentHostFilter = null;

    function connectStatusWebSocket() {
        const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${wsProtocol}//${window.location.host}/ws/containers/status`;

        statusSocket = new WebSocket(wsUrl);

        statusSocket.onopen = function () {
            console.log('üì° Status WebSocket connected');
            document.getElementById('ws-status')?.classList.add('bg-green-500');
            document.getElementById('ws-status')?.classList.remove('bg-red-500');
        };

        statusSocket.onmessage = function (event) {
            try {
                const data = JSON.parse(event.data);
                if (data.type === 'status_update') {
                    updateContainerTable(data.containers);
                }
            } catch (e) {
                console.error('Parse error:', e);
            }
        };

        statusSocket.onclose = function () {
            console.log('‚ùå Status WebSocket closed, reconnecting...');
            document.getElementById('ws-status')?.classList.remove('bg-green-500');
            document.getElementById('ws-status')?.classList.add('bg-red-500');
            // Reconnect after 3 seconds
            setTimeout(connectStatusWebSocket, 3000);
        };

        statusSocket.onerror = function (error) {
            console.error('WebSocket error:', error);
        };
    }

    function updateContainerTable(containers) {
        // Filter by current host if selected
        let filtered = containers;
        if (currentHostFilter) {
            filtered = containers.filter(c => c.host === currentHostFilter);
        }

        const tbody = document.getElementById('container-list');
        if (!tbody || filtered.length === 0) return;

        // Update existing rows or rebuild
        filtered.forEach(c => {
            const row = document.querySelector(`tr[data-container-id="${c.id}"]`);
            if (row) {
                // Update status cell
                const statusCell = row.querySelector('.status-cell');
                if (statusCell) {
                    const isRunning = c.state.toLowerCase().includes('running');
                    statusCell.innerHTML = `
                        <div class="flex items-center gap-2">
                            <span class="w-2.5 h-2.5 rounded-full ${isRunning ? 'bg-green-500 animate-pulse shadow-[0_0_8px_rgba(34,197,94,0.6)]' : 'bg-red-500'}"></span>
                            <div class="flex flex-col">
                                <span class="text-xs text-white uppercase font-bold">${c.state}</span>
                                <span class="text-[10px] text-gray-400 font-mono">${c.status}</span>
                            </div>
                        </div>
                    `;
                }
            }
        });
    }

    // Track host filter changes
    document.addEventListener('htmx:afterRequest', function (evt) {
        const url = evt.detail.requestConfig?.path;
        if (url && url.includes('/containers/list')) {
            const match = url.match(/host_name=([^&]+)/);
            currentHostFilter = match ? decodeURIComponent(match[1]) : null;
        }
    });

    // Start WebSocket connection
    document.addEventListener('DOMContentLoaded', connectStatusWebSocket);
</script>
{% endblock %}